# SPI

## SPI란?
- **Serial Peripheral Interface**의 약자.
- **동기식 직렬 통신**: 공통 **클럭(SCLK)**에 맞춰 마스터와 슬레이브가 데이터를 주고받음.
- 기본 배선:
    - **SCLK**(Serial Clock): 마스터가 생성하는 클럭.
    - **MOSI**(Master Out Slave In): 마스터 → 슬레이브 데이터 라인.
    - **MISO**(Master In Slave Out): 슬레이브 → 마스터 데이터 라인.
    - **CS/SS**(Chip Select/Slave Select): 특정 슬레이브를 선택하는 활성 LOW 신호.
- **전이중(Full-duplex)**: MOSI/MISO가 분리되어 송수신이 동시에 가능.
- **Point-to-Multipoint** 구조: 여러 슬레이브 연결 가능(슬레이브마다 CS 필요).
- 변형: 3-wire(half-duplex, MOSI/MISO 공유: SDIO), Dual/Quad/Octal SPI(QSPI/OSPI)(플래시에 주로), DDR 모드 등.

## 신호와 프레임 구조
```test
CS_n:   ─────┐____________________________________┌──────
SCK:         _/‾\_/‾\_/‾\_/‾\_/‾\_/‾\_/‾\_/‾\_/‾\_
MOSI:        [  b7  ][  b6  ][  b5  ][  ...  ][ b0 ]
MISO:        [  r7  ][  r6  ][  r5  ][  ...  ][ r0 ]

(Start)                                      (End)
```
- CS (Chip Select): 낮으면(active low) 해당 슬레이브가 통신에 응답. 전송 종료 시 HIGH로 복귀.
- SCLK: 마스터가 구동. 각 에지마다 MOSI 비트 출력, MISO 비트 샘플링 수행.
- MOSI/MISO: 전송되는 실제 데이터(보통 8비트 기준, 다양한 비트 길이 가능).
- 프레임 구조: 별도의 START/STOP 비트 없음. CS선 active 상태 동안 클럭에 맞춰 데이터만 연속 전송.
- 읽기 때도 마스터는 더미 바이트(예: 0x00)를 보내면서 클럭을 공급해야 함(동기식이므로).

## SPI 모드 (CPOL / CPHA)
- 타이밍은 **클럭 극성(CPOL)**과 **클럭 위상(CPHA)**에 의해 4가지 모드가 정의됨.
- **CPOL**: 클럭의 Idle 상태 (0=Low idle, 1=High idle).
- **CPHA**: 몇 번째 에지에서 샘플링할지 (0=첫 번째 에지, 1=두 번째 에지).
- 마스터·슬레이브 모두 동일 모드로 맞춰야 함

| 모드 | CPOL | CPHA | 유휴(Idle) | 샘플링 에지 | 시프트 에지 | 설명
|:---:|:---:|:---:|:---:|:---:|:---:|:---|
| Mode 0 | 0 | 0 | Low | ↑ | ↓ | Rising edge에서 샘플링
| Mode 1 | 0 | 1 | Low | ↓ | ↑ | Falling edge에서 샘플링
| Mode 2 | 1 | 0 | High | ↓ | ↑ | Falling edge에서 샘플링
| Mode 3 | 1 | 1 | High | ↑ | ↓ | Rising edge에서 샘플링

## 핵심 설정
- 클럭 주파수(SCLK): 수 kHz ~ 수십 MHz 가능. 슬레이브 사양에 맞게 설정.
- 데이터 비트 길이: 보통 8비트(1바이트), 하지만 4~16비트 등도 지원.
- 비트 순서: 대부분 MSB First, 일부 LSB First 지원(양쪽 일치 필수).
- Chip Select (CS/SS): 다수 슬레이브 사용 시 각각 전용 CS 라인 필요.
- 파형 모드: CPOL/CPHA 조합으로 정의, 반드시 마스터와 슬레이브 일치 필요.
- 멀티슬레이브: 단일 MOSI/MISO/SCLK에 슬레이브 공유, CS를 통해 1:1로만 활성화.

## 버스 토폴로지/배선 팁
- 포인트-투-멀티슬레이브: 선은 공유 가능하나 CS 핀은 개별 필요 → 슬레이브 수에 따라 마스터 핀 많이 소모.
- 클럭 속도가 높을수록 배선 길이 제한이 큼(수십 cm 내외).
- 라인의 임피던스 매칭·배선 길이 균형 필요(특히 MISO·MOSI).
- 보드 간 통신보다는 보드 내 고속 주변기기 연결에 최적.

## SPI 주요 사용처
- 고속 메모리: Flash, EEPROM, SD 카드.
- DAC/ADC: 고속 신호 변환 칩.
- 디스플레이 제어: LCD, OLED, TFT, 터치스크린 드라이버.
- 센서: 고속 데이터 전송이 필요한 센서(자이로, 가속도, 이미지 센서 등).
- MCU ↔ MCU 간 고속 데이터 전송.

## 장/단점
| 구분 | 내용
|:---:|:---
| 장점 | - 단순 구조로 빠른 통신 가능(수 MHz~수십 MHz).<br>- 전이중(full-duplex)으로 동시에 송·수신 가능.<br>- Start/Stop/ACK 없음 → 프로토콜 오버헤드가 최소화.<br>- 하드웨어 구현이 간단.
| 단점 | - 주소 개념 없음(하드웨어로만 선택).<br>- 버스 멀티드롭(많은 슬레이브)엔 비효율적.<br>- 장거리 전송 불리(수십 cm 내 제한).

## 비동기 vs 동기 통신 (UART vs I²C vs SPI)
- **UART**(비동기): 클럭 없이 Start/Stop 비트로 동기화, 1:1 통신.
- **I²C**(동기, 멀티마스터/슬레이브): 2선, 주소 기반 멀티드롭 네트워크. 저속·저전력 주변기기 제어에 특화.
- **SPI**(동기, 고속, 전이중): 클럭 + MISO/MOSI/CS 라인 다수 필요, 속도 빠르고 단일 보드 내 고성능 통신에 적합.

## 비교표
| 항목 | UART | I²C | SPI
|:---|:---:|:---:|:---:
| 기본구조 | 비동기(클럭 없음) | 동기(클럭 있음, SCL) | 동기(클럭 있음, SCLK)
| 신호/배선 | TX, RX(+GND). 필요시 RTS/CTS | SCL(클럭), SDA(데이터)(+GND) | SCK, MOSI, MISO, CS(+GND)
| 통신방식 | 1:1 Point-to-Point | 다수 마스터·슬레이브(멀티드롭) | 마스터 1 : 슬레이브 N
| Duplex | 전이중 Full-duplex | 반이중 Half-duplex | 전이중 Full-duplex
| 주소/프레이밍 | 주소 개념 없음(상위 프로토콜) | 7/10비트 주소, ACK/NACK | 주소 없음, CS로 슬레이브 선택
| 속도 | 수 kbps ~ 수 Mbps(일반 TTL) | 100k/400k/1M/3.4M(일반) | 수 MHz ~ 수십 MHz(보드 내)
| 전송거리 | 길다(수 m~수십 m) | 짧다(수십 cm~수 m) | 매우 짧다(수십 cm 내외)
| 멀티슬레이브 | 불가능 | 쉬움 | 복잡함 (CS 핀 x 슬레이브 수)
| 대표 용도 | 디버그 콘솔, 모뎀/모듈 제어, PC-칩, 부트로더 | 센서·EEPROM·디스플레이 저속 제어 | 플래시/SD, 디스플레이, 고속 센서/ADC, 스트리밍